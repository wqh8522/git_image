# Aerospike二级索引

## 简介

辅助索引位于非主键上，允许您对一对多关系建模。在Aerospike中，二级索引是逐个bin指定的（如RDBMS *列*）。这允许有效更新并最小化存储索引所需的资源量。

数据描述（DDL）确定要索引的bin和数据类型。使用Aerospike工具或API动态创建和删除索引。此DDL（类似于RDBMS模式）**不**用于数据验证 - 即使bin在DDL中作为索引，bin也是可选的。对于索引bin，更新记录以包含bin会更新索引。

索引条目是类型检查的，即如果您有一个存储用户年龄的bin，并且年龄值由一个应用程序存储为字符串而另一个应用程序存储整数，则整数索引会排除包含存储在索引bin中的字符串值的记录，而字符串索引排除存储在索引bin中的整数值的记录。

二级指数：

- 存储在RAM中以便快速查找。
- 构建在集群中的每个节点上，并与主索引位于同一位置。每个辅助索引条目仅包含对节点本地记录的引用。
- 包含指向集群中主记录和复制记录的指针。

## 数据结构

![](https://raw.githubusercontent.com/wqh8522/my_note/pic/as/as%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png)

与主键索引一样，二级索引是哈希表与B树的混合。二级索引在结构上是B树的哈希。每个逻辑二级索引都有32个物理树。对于密钥标识的索引操作，散列函数确定二级索引条目的哪个物理树必须由32个物理树组成。识别之后，将B树更新到树中。请注意，对应于单个辅助索引键，可以有许多主记录引用。此结构的最低级别是基于需要存储的记录数量的完整B树列表。 

## 索引管理

### 索引元数据

Aerospike跟踪哪些索引是在全局维护的数据结构中创建的 - 系统元数据（System Metadata - SMD）系统。SMD模块位于多个节点上的多个二级索引模块的中间。始终从SMD触发对二级索引所做的更改。

![](https://raw.githubusercontent.com/wqh8522/my_note/pic/as/%E4%BB%8ESMD%E8%A7%A6%E5%8F%91%E7%9A%84%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95.png)

SMD工作流程：

1. 客户端请求会触发与二级索引元数据相关的创建，删除或更新。请求通过二级索引模块传递给SMD
2. SMD将请求发给paxos主服务器。
3. paxos主站请求来自所有集群节点的相关元数据
4. 一旦收到所有数据，它就会调用二级索引合并回调函数。此功能可解析辅助索引的获胜元数据版本。
5. SMD向所有群集节点发送请求以接受新元数据。
6. 每个节点执行二级索引创建或删除DDL功能。
7. 触发扫描并返回客户端。

### 索引创建

AS的二级索引支持动态创建，可以使用aql工具和客户端API创建、读取和销毁索引。

构建二级索引，需指定命名空间，set，bin，容器类型（none，list，map）和数据类型（Integer、String、geojson等）。在SMD确认后，每个节点以写入活动模式创建二级索引，启动后扫描所有数据并在二级索引中插入条目。

- 仅为匹配所有索引规范的记录创建索引条目。
- 扫描会填充二级索引，并与读取/写入事务交互完全正常扫描，除了索引创建没有网络组件。在创建索引期间，影响索引属性的所有新写入都会更新索引。索引创建扫描完成并在所有群集节点上创建所有索引条目后，索引将标记为“已读”并准备好供查询使用。
- Aerospike还支持顶级列表和地图的索引

建议：

- 当集群格式不正确或遇到完整性故障时，请避免使用索引DDL（create-drop index）。索引构建是一个繁重的I / O子系统操作，因此只应在低负载期间完成。
- 如果具有数据的节点加入群集但缺少索引定义，则会在加入群集后创建并填充索引。在索引填充期间，不允许查询确保传入节点上的数据在可用之前是干净的。

> 要确保索引创建扫描不会对正在进行的读取和写入事务的延迟产生负面影响，请将索引构建优先级设置为适当的级别。使用Aerospike实时引擎中的作业优先级设置来控制索引创建扫描的资源利用率。

#### 通过aql创建

语法格式：

```sql
创建索引
CREATE LIST/MAPKEYS/MAPVALUES INDEX <index> ON <ns>[.<set>] (<bin>) NUMERIC|STRING|GEO2DSPHERE
--LIST/MAPKEYS/MAPVALUES : 容器类型，支持这三种类型
--<index>：索引名称
--<ns>[.<set>]：命名空间.集合；集合是可选的
--(<bin>)：指定在哪个bin上创建
--NUMERIC|STRING|GEO2DSPHERE：数据类型

删除索引
 DROP INDEX <ns>[.<set>] <index>
```

![](https://raw.githubusercontent.com/wqh8522/my_note/pic/as/create_second_index.png)

```sql
--插入数据
insert into test.myset (PK,name,email,shopping_cart) values ("1","wqh",'JSON["bob@email1.com", "bob@email2.com", "bob@email3.com"]','JSON{"Phone" : "CA", "Car": "AZ", "Rope":"Texas"}')

--在email上创建二级索引
create list index email_index on test.myset (email) string

--使用二级索引查询
select * from test.myset in list where email="bob@email1.com"

--删除索引
 drop index test.myset email_index
```

#### 通过java客户端创建

- 创建二级索引

![创建二级索引](https://raw.githubusercontent.com/wqh8522/my_note/pic/as/java%E5%88%9B%E5%BB%BA%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95.png)

- 删除二级索引

![](https://raw.githubusercontent.com/wqh8522/my_note/pic/as/java%E5%88%A0%E9%99%A4%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95.png)

- 使用二级索引查询

![](https://raw.githubusercontent.com/wqh8522/my_note/pic/as/%E4%BD%BF%E7%94%A8%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95.png)

## 分布式查询

### 查询过程

![](https://raw.githubusercontent.com/wqh8522/my_note/pic/as/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%84.png)

每个集群节点都接收查询以从二级索引检索结果。查询执行时：

1. 请求“分散”到所有节点。
2. 索引放在RAM中，用于快速映射辅助到主键。
3. 索引与每个节点共同位于SSD上的数据，以提供快速更新性能。
4. 记录从所有SSD和RAM并行读取。
5. 结果在每个节点上聚合。
6. 结果从所有节点“收集”并返回给客户端。

### 查询结果

查询过程确保每次查询执行和扫描记录时结果与实际数据同步。未提交的数据读取永远不会成为查询结果的一部分。群集状态更改，下面列出了辅助索引重建和查询结果一致性方案。

| 脚本     | 持久命名空间引导类型                                   | 数据内存 | 二级指数人口                         | 节点启动时间                     | 迁移期间查询一致性 |
| -------- | ------------------------------------------------------ | -------- | ------------------------------------ | -------------------------------- | ------------------ |
| 节点加入 | 有数据; 没有启用快速重启功能（1）                      | 假       | 从磁盘发布数据负载; 并行数据分区扫描 | 比没有二级索引的数据加载时间更长 | 尽力而为（2）      |
| 节点加入 | 有数据; 启用快速重启功能（主密钥索引在共享内存中可用） | 假       | 快速重启; 并行数据分区扫描（1）      | 比没有二级索引的数据加载时间更长 | 尽力而为（2）      |
| 节点加入 | 有数据; 启用快速重启功能                               | 真正     | 从磁盘加载数据                       | 有和没有二级索引没有显着差异     | 尽力而为（2）      |
| 节点加入 | 没有数据; 始终未启用快速重启功能                       | 真假     | -NA-                                 | -NA-                             | 一致的副本         |
| 节点离开 | - NA -                                                 | 真假     | -NA-                                 | -NA-                             | 一致的副本         |

1. 二级索引不支持快速重启。
2. Best Effort是一个事务一致的数据副本，但不一定是最新的。对于重复记录，在通过辅助索引查询返回结果之前**不会**执行合并。完成所有迁移后，始终存在一致的副本。